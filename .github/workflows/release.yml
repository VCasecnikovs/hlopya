name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    runs-on: macos-15
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Set up signing certificate
        if: env.CERTIFICATE_BASE64 != ''
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          echo "$CERTIFICATE_BASE64" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Fix entitlements
        run: make fix-entitlements

      - name: Build
        run: |
          SIGN_ARGS=""
          if [ -z "${{ secrets.APPLE_CERTIFICATE_BASE64 }}" ]; then
            SIGN_ARGS="CODE_SIGN_IDENTITY=- CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO"
          fi

          xcodebuild -project Hlopya.xcodeproj \
            -scheme Hlopya \
            -configuration Release \
            -derivedDataPath .build/xcode \
            $SIGN_ARGS \
            build

      - name: Package app
        run: |
          cd .build/xcode/Build/Products/Release
          ditto -c -k --keepParent Hlopya.app Hlopya.app.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: .build/xcode/Build/Products/Release/Hlopya.app.zip
          generate_release_notes: true
          draft: false

      - name: Clean up keychain
        if: always()
        run: |
          if [ -f "$RUNNER_TEMP/app-signing.keychain-db" ]; then
            security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db"
          fi
